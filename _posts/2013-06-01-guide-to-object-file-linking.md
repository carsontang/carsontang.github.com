---
layout: post
title: "Guide to Object File Linking"
category: unix
tags: [unix, c]
---
{% include JB/setup %}

### What is a linker?
A program that combines one or more object files generated by the compiler into a single
file that can be copied into memory and executed.

### What is an object file?
Object files contain binary code. There are three forms of object files:
* relocatable object file
* executable object file
* shared object file

### Relocatable object file
Assemblers produce relocatable object files. They are "relocatable" because the functions and variables
are not bound to any specific address. Instead, the addresses are still symbols.

This file contains binary code and data that can be combined with other relocatable object
files at compile time to create an executable object file.

An example of a relocatable object file might be a collection of math functions.

{% highlight c %}
/* math.c
 * A simple math library
 */

int add(int a, int b)
{
  return a + b;
}
{% endhighlight %}

    unix > gcc -c math.c                      # Create relocatable obj file (math.o)
    unix > readelf -h math.o | grep Type      # Read math.o with readelf
    Type:            REL (Relocatable file)   # and verify its type

This relocatable object file can now be compiled with any other program to create
an executable object file.

{% highlight c %}
/* math.h */
#ifndef MATH_H
#define MATH_H
int add(int a, int b);
#endif

/* math_test.c */
#include <stdio.h>
#include "math.h"

int main(void)
{
  int result = add(1, 2);
  printf("result: %d\n", result);
  return 0;
}

{% endhighlight %}

    unix > gcc math_test.c -o math_test
    /tmp/cclRibQq.o: In function `main':
    math_test.c:(.text+0x19): undefined reference to `add'
    collect2: ld returned 1 exit status

What just happened? Why couldn't I produce a math_test program? My math_test program references
the add method, but the implementation for the add method is in the math.o relocatable object file.
The gcc compiler system doesn't know that, so it can't magically link the math.o file with my program.
Thus, I must specify that I'm linking in math.o.

    unix > gcc math_test.c math.o -o math_test
    unix > ./math_test
    result: 3

### Extra: Relocatable Object File
To more deeply understand the meaning of "relocatable", look at the difference between the symbol
tables of a relocatable object file and an executable object file.

    unix > gcc -c main.c
    unix > readelf --symbols main.o
    Num:     Value   Size     Type      Bind       Vis     Ndx  Name
      0:  00000000      0   NOTYPE     LOCAL   DEFAULT     UND
      1:  00000000      0   FILE       LOCAL   DEFAULT     ABS  main.c
      2:  00000000      0   OBJECT    GLOBAL   DEFAULT     3    buf
      3:  00000000      0   OBJECT    GLOBAL   DEFAULT     1    main

    unix > gcc main.c -o main
    unix > readelf --symbols main
    Num:     Value   Size     Type      Bind       Vis     Ndx  Name
     53:  08048460      2     FUNC    GLOBAL   DEFAULT     13   __libc_csu_fini
     54:  08048462      0     FUNC    GLOBAL   HIDDEN      13   __i686.get_pc_thunk.bx
     55:  0804a018      4     OBJECT  GLOBAL   DEFAULT     13   bufp0

Above are excerpts of the object files. The relocatable object file has symbols associated
with the 00000000 address. The executable object file has symbols associated with real addresses.
After the compiler and assembler generate the relocatable object file, the data start at address 0.
The linker then _relocates_ these sections by associating each with a location with in memory.

### What does ELF stand for?
executable and linkable format

### What is an ELF file?
An ELF file is a file containing binary data.